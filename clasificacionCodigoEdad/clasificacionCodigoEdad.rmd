```{r}
# Install and load the lubridate package if not already installed
if (!requireNamespace("lubridate", quietly = TRUE)) {
  install.packages("lubridate")
}
library(lubridate)

# Install and load the xgboost package if not already installed
if (!requireNamespace("xgboost", quietly = TRUE)) {
  install.packages("xgboost")
}
library(xgboost)

# Install and load the caret package if not already installed
if (!requireNamespace("caret", quietly = TRUE)) {
  install.packages("caret")
}
library(caret)
```

# Step 1: Data Preprocessing

```{r}
# Load dataset
anillamientos <- read.csv("../limpieza/limpio/anillamiento_familia.csv")
```

```{r}
anillamientos_especie <- anillamientos[, (names(anillamientos) %in% c("NombreEspecie", "FechaCaptura", "CodigoEdad", "MUNICIPIO"))]
anillamientos_familia <- anillamientos[, (names(anillamientos) %in% c("Familia", "FechaCaptura", "CodigoEdad", "MUNICIPIO"))]
anillamientos_orden <- anillamientos[, (names(anillamientos) %in% c("Orden", "FechaCaptura", "CodigoEdad", "MUNICIPIO"))]
anillamientos_grupo <- anillamientos[, (names(anillamientos) %in% c("Grupo", "FechaCaptura", "CodigoEdad", "MUNICIPIO"))]
```

```{r}
dataset_trabajo <- anillamientos_especie #A modificar para lo que busquemos
names(dataset_trabajo)[1] <- "Identificador"
dataset_trabajo$FechaCaptura <- as.Date(dataset_trabajo$FechaCaptura)
dataset_trabajo$MesCaptura <- month(dataset_trabajo$FechaCaptura)
dataset_trabajo <- dataset_trabajo[, (!names(dataset_trabajo) %in% c("FechaCaptura"))]
```

```{r}
dataset_trabajo <- dataset_trabajo[dataset_trabajo$MUNICIPIO != "", ]
dataset_trabajo$CodigoEdad <- as.numeric(dataset_trabajo$CodigoEdad)
dataset_trabajo <- dataset_trabajo[dataset_trabajo$CodigoEdad <= 9, ]
dataset_trabajo$Identificador <- as.integer(as.factor(dataset_trabajo$Identificador))
dataset_trabajo$MUNICIPIO <- as.integer(as.factor(dataset_trabajo$MUNICIPIO))
```

```{r}
dataset_trabajo <- na.omit(dataset_trabajo)
```


```{r}
set.seed(123)
train_index <- sample(1:nrow(dataset_trabajo), 0.7*nrow(dataset_trabajo))
train_data <- dataset_trabajo[train_index, ]
test_data <- dataset_trabajo[-train_index, ]
train_control <- trainControl(method = "cv", number = 5)
```

# Step 2: Model Training

# Train a xgb models

```{r}
xgb_model_100 <- xgboost(data = as.matrix(train_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]),
                     label = train_data$CodigoEdad,
                     nrounds = 100,
                     verbose = FALSE,
                     objective = "multi:softmax",
                     num_class = 10
)
```

```{r}
xgb_model_1000 <- xgboost(data = as.matrix(train_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]),
                     label = train_data$CodigoEdad,
                     nrounds = 1000,
                     verbose = FALSE,
                     objective = "multi:softmax",
                     num_class = 10
)
```

```{r}
param_grid_100 <- expand.grid(
  nrounds = 100,
  max_depth = c(3, 6, 9),
  eta = c(0.01, 0.1, 0.3),
  gamma = c(0, 0.1, 0.2),
  colsample_bytree = c(0.6, 0.8, 1),
  min_child_weight = c(1, 3, 5),
  subsample = c(0.6, 0.8, 1)
)

xgb_model_100_cv <- train(
  x = as.matrix(train_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]),
  y = train_data$CodigoEdad,
  method = "xgbTree",
  trControl = train_control,
  verbose = FALSE,
  tuneGrid = param_grid_100,
  objective = "multi:softmax",
  num_class = 10
)
```

```{r}
param_grid_1000 <- expand.grid(
  nrounds = 1000,
  max_depth = c(3, 6, 9),
  eta = c(0.01, 0.1, 0.3),
  gamma = c(0, 0.1, 0.2),
  colsample_bytree = c(0.6, 0.8, 1),
  min_child_weight = c(1, 3, 5),
  subsample = c(0.6, 0.8, 1)
)

xgb_model_1000_cv <- train(
  x = as.matrix(train_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]),
  y = train_data$CodigoEdad,
  method = "xgbTree",
  trControl = train_control,
  verbose = FALSE,
  tuneGrid = param_grid_1000,
  objective = "multi:softmax",
  num_class = 10
)
```

# Step 3: Model Evaluation

# Predict on the testing set and evaluate
```{r}
predictions_100 <- predict(xgb_model_100, as.matrix(test_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]))
conf_matrix_100 <- table(predictions_100, test_data$CodigoEdad)
accuracy_100 <- sum(diag(conf_matrix_100)) / sum(conf_matrix_100)
print(paste("Accuracy 100 rounds:", accuracy_100))
```

```{r}
predictions_1000 <- predict(xgb_model_1000, as.matrix(test_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]))
conf_matrix_1000 <- table(predictions_1000, test_data$CodigoEdad)
accuracy_1000 <- sum(diag(conf_matrix_1000)) / sum(conf_matrix_1000)
print(paste("Accuracy 1000 rounds:", accuracy_1000))
```

```{r}
predictions_100_cv <- predict(xgb_model_100_cv, as.matrix(test_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]))
conf_matrix_100_cv <- table(predictions_100_cv, test_data$CodigoEdad)
accuracy_100_cv <- sum(diag(conf_matrix_100_cv)) / sum(conf_matrix_100_cv)
print(paste("Accuracy 100 rounds with cross validation:", accuracy_100_cv))
```

```{r}
predictions_1000_cv <- predict(xgb_model_1000_cv, as.matrix(test_data[, c("Identificador", "MUNICIPIO", "MesCaptura")]))
conf_matrix_1000_cv <- table(predictions_1000_cv, test_data$CodigoEdad)
accuracy_1000_cv <- sum(diag(conf_matrix_1000_cv)) / sum(conf_matrix_1000_cv)
print(paste("Accuracy 1000 rounds with cross validation:", accuracy_1000_cv))
```

# Step 4: Prediction

# If satisfied with the model performance, predict on new data
# Example:
# new_data <- data.frame(species = "New_Species", municipality = "New_Municipality", month = "New_Month")
# prediction_new <- predict(rf_model, newdata = new_data)
